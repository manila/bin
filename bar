#!/bin/bash
# ~/barf.sh
#
# Manuel Nila - Aug 2018

source "$(dirname $0)/config_bar.conf"

dateandtime() {
	echo "$( date '+%a %I:%M' ) "
}

batteryinfo() {
	# Get battery percent from acpi, trim away whitespace and extra chars
	batt="$( acpi | awk '{ print $4 }' | tr ' ,%\t\n' ' ' )"

	# Four levels of battery, limited by font awesome free :(
	if [ $batt -gt 90 ]; then
		batt="\uf240"
	elif [ $batt -gt 60 ]; then
		batt="\uf241"
	elif [ $batt -gt 40 ]; then
		batt="\uf242"
	elif [ $batt -gt 20 ]; then
		batt="\uf243"
	else
		batt="\uf244"
	fi
	echo "%{T2}$batt%{T1}"
}

cpuinfo() {
	echo "$( ps aux | awk '{ load+=$3 } END { print load }' )"
}

meminfo() {
	echo "$( cat /proc/meminfo | awk '\
	NR < 3 \
	{if (NR == 1) { free=$2; next }} \
	{if (NR == 2) { free-=$2; next }} \
	END \
	{{if ((free/1000/1000) < 1) { printf "%3dMB", (free/1000) }} \
	{if ((free/1000/1000) > 1) { printf "%1.2fGB", (free/1000/1000) }}}'
)"

}

brightness() {
	echo "$( awk '{ if (FNR==NR) { value=$0; next } { printf "%2.0d", (value / $0 * 100) }}' /sys/class/backlight/intel_backlight/brightness /sys/class/backlight/intel_backlight/max_brightness )"
}

networking() {
	echo "hi"
}

volume() {
	echo "$( amixer get Master | awk 'END { print $4 }' )"
}

uptime() {
	echo "\0"
}

window_focus() {
	id=$( xprop -root _NET_ACTIVE_WINDOW | awk '{ print $5 }')
	window_name="$( xprop -id $id WM_CLASS | awk '{ print $4 }' | xargs )"

	echo "$window_name"
}

parse_net_wm_name () {		
	echo "$( xprop -id $1 2> /dev/null | awk '/_NET_WM_NAME/' | cut -d '"' -f2 )"
}

#Status Bar
while :; do
	# Find Spotify Window ID
	if [[ "$(window_focus)" == "Spotify" && $spot_id == '' ]]; then
		 spot_id="$( xprop -root _NET_ACTIVE_WINDOW | awk '{ print $5 }')"	
	fi

	# Update now playing
	now_playing="$( parse_net_wm_name $spot_id )"

	echo -e " $(window_focus) %{cT2F#6AE368}\uf1bc%{T1} $now_playing  %{F#FFFFFFr}\uf0e4 $(cpuinfo) \uf2db $(meminfo) \uf028 $(volume) $(batteryinfo) $(dateandtime)"
	sleep 2
done
